<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CorteMaestro - Optimizador M칩vil</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --dark: #1e293b;
            --bg: #f8fafc;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 10px;
            color: var(--dark);
        }

        .container { max-width: 100%; margin: auto; }

        header { text-align: center; padding: 10px 0; }
        h1 { font-size: 1.5rem; margin: 0; color: var(--primary); }
        p { font-size: 0.9rem; margin: 5px 0 15px; opacity: 0.7; }

        .card { 
            background: white; 
            padding: 15px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            margin-bottom: 15px; 
        }

        .input-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-bottom: 15px; 
        }

        label { font-size: 0.8rem; font-weight: bold; margin-bottom: 4px; display: block; }
        
        input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #cbd5e1; 
            border-radius: 8px; 
            font-size: 16px; /* Evita zoom autom치tico en iOS */
            box-sizing: border-box;
        }

        /* Estilo de lista de piezas para m칩vil */
        .piece-entry {
            background: #f1f5f9;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            position: relative;
        }

        .piece-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 8px;
        }

        .btn {
            border: none;
            border-radius: 8px;
            padding: 14px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            transition: 0.2s;
        }

        .btn-add { background: var(--success); color: white; margin-bottom: 10px; }
        .btn-calc { background: var(--primary); color: white; }
        .btn-del { 
            background: var(--danger); 
            color: white; 
            padding: 5px 10px; 
            font-size: 0.8rem; 
            width: auto;
            margin-top: 8px;
        }

        #results { 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            margin-top: 20px; 
        }

        .sheet-container { 
            background: white; 
            padding: 10px; 
            border-radius: 12px; 
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        canvas { 
            max-width: 100%; 
            height: auto; 
            background: #fff;
            margin-top: 10px;
        }

        .stats-badge {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 8px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>游뿤 Optimizador M칩vil</h1>
        <p>Hoja: 122 x 244 cm</p>
    </header>

    <div class="card">
        <label>Grosor del Disco / Kerf (cm)</label>
        <input type="number" id="kerf" value="0.3" step="0.1" inputmode="decimal">
        
        <div id="piecesList" style="margin-top: 15px;">
            <div class="piece-entry">
                <div class="piece-grid">
                    <div><label>Nombre</label><input type="text" placeholder="Ej: Puerta"></div>
                    <div><label>Ancho</label><input type="number" class="w" value="40" inputmode="decimal"></div>
                    <div><label>Largo</label><input type="number" class="l" value="80" inputmode="decimal"></div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div style="width: 45%;"><label>Cantidad</label><input type="number" class="q" value="2" inputmode="numeric"></div>
                    <button class="btn btn-del" onclick="removeRow(this)">Eliminar</button>
                </div>
            </div>
        </div>

        <button class="btn btn-add" onclick="addRow()">+ A침adir Pieza</button>
        <button class="btn btn-calc" onclick="generateLayout()">CALCULAR CORTE</button>
    </div>

    <div id="results"></div>
</div>

<script>
    function addRow() {
        const list = document.getElementById("piecesList");
        const div = document.createElement("div");
        div.className = "piece-entry";
        div.innerHTML = `
            <div class="piece-grid">
                <div><label>Nombre</label><input type="text" placeholder="Pieza"></div>
                <div><label>Ancho</label><input type="number" class="w" inputmode="decimal"></div>
                <div><label>Largo</label><input type="number" class="l" inputmode="decimal"></div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div style="width: 45%;"><label>Cantidad</label><input type="number" class="q" inputmode="numeric"></div>
                <button class="btn btn-del" onclick="removeRow(this)">Eliminar</button>
            </div>
        `;
        list.appendChild(div);
    }

    function removeRow(btn) { btn.closest('.piece-entry').remove(); }

    function getRandomColor() {
        const colors = ['#f87171', '#fb923c', '#fbbf24', '#4ade80', '#2dd4bf', '#38bdf8', '#818cf8', '#c084fc'];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    function generateLayout() {
        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = "";
        
        const kerf = parseFloat(document.getElementById("kerf").value) || 0;
        const SHEET_W = 122;
        const SHEET_L = 244;
        const SCALE = 2.5; 

        let allPieces = [];
        document.querySelectorAll(".piece-entry").forEach(row => {
            const w = parseFloat(row.querySelector(".w").value);
            const l = parseFloat(row.querySelector(".l").value);
            const q = parseInt(row.querySelector(".q").value);
            const color = getRandomColor();
            if(w && l && q) {
                for(let i=0; i<q; i++) {
                    let pw = Math.min(w, l);
                    let pl = Math.max(w, l);
                    allPieces.push({w: pw, l: pl, color: color});
                }
            }
        });

        allPieces.sort((a, b) => (b.w * b.l) - (a.w * a.l));

        let sheetIdx = 1;
        while (allPieces.length > 0) {
            let currentSheet = { pieces: [], usedArea: 0 };
            let spaces = [{ x: 0, y: 0, w: SHEET_W, l: SHEET_L }];

            for (let i = 0; i < allPieces.length; i++) {
                let p = allPieces[i];
                let fitFound = false;

                for (let j = 0; j < spaces.length; j++) {
                    let s = spaces[j];
                    let modes = [{w: p.w, l: p.l}, {w: p.l, l: p.w}];
                    
                    for (let mode of modes) {
                        if (mode.w <= s.w && mode.l <= s.l) {
                            currentSheet.pieces.push({x: s.x, y: s.y, w: mode.w, l: mode.l, color: p.color});
                            currentSheet.usedArea += (mode.w * mode.l);
                            let remW = s.w - mode.w - kerf;
                            let remL = s.l - mode.l - kerf;
                            if (remW > 0) spaces.push({ x: s.x + mode.w + kerf, y: s.y, w: remW, l: mode.l });
                            if (remL > 0) spaces.push({ x: s.x, y: s.y + mode.l + kerf, w: s.w, l: remL });
                            spaces.splice(j, 1);
                            allPieces.splice(i, 1);
                            i--; fitFound = true; break;
                        }
                    }
                    if (fitFound) break;
                }
            }

            // Renderizado
            const container = document.createElement("div");
            container.className = "sheet-container";
            container.innerHTML = `<strong>HOJA #${sheetIdx}</strong><br>`;
            
            const canvas = document.createElement("canvas");
            canvas.width = SHEET_W * SCALE;
            canvas.height = SHEET_L * SCALE;
            const ctx = canvas.getContext("2d");
            ctx.fillStyle = "#fff7ed";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            currentSheet.pieces.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.strokeStyle = "#334155";
                ctx.fillRect(p.x * SCALE, p.y * SCALE, p.w * SCALE, p.l * SCALE);
                ctx.strokeRect(p.x * SCALE, p.y * SCALE, p.w * SCALE, p.l * SCALE);
                if(p.w > 10) {
                    ctx.fillStyle = "#000";
                    ctx.font = "bold 10px sans-serif";
                    ctx.fillText(`${p.w}x${p.l}`, (p.x + 2)*SCALE, (p.y + 8)*SCALE);
                }
            });

            const eff = ((currentSheet.usedArea / (SHEET_W * SHEET_L)) * 100).toFixed(1);
            container.appendChild(canvas);
            container.innerHTML += `<br><span class="stats-badge">Eficiencia: ${eff}%</span>`;
            resultsDiv.appendChild(container);
            sheetIdx++;
        }
    }
</script>

</body>
</html>
