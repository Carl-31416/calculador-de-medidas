<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CorteMaestro Fix</title>
    <style>
        :root { --p: #2563eb; --s: #10b981; --bg: #f1f5f9; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 10px; }
        input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .piece-entry { background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid var(--p); }
        .btn { border: none; border-radius: 8px; padding: 15px; color: white; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer; }
        .btn-add { background: var(--s); }
        .btn-calc { background: var(--p); font-size: 1.1rem; }
        .btn-del { background: #ef4444; padding: 5px; margin-top: 5px; font-size: 0.8rem; }
        
        /* CONTENEDOR DE RESULTADOS CORREGIDO */
        #results { margin-top: 20px; }
        .sheet-wrapper { 
            background: white; 
            padding: 10px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            overflow-x: auto; /* Permite deslizar si el dibujo es grande */
            text-align: center;
        }
        canvas { 
            background: #fff7ed; 
            border: 2px solid #334155; 
            display: block;
            margin: 10px auto;
            image-rendering: crisp-edges; /* Mejora nitidez en móviles */
        }
        .stats { font-weight: bold; color: var(--p); background: #dbeafe; padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="card">
        <h2 style="margin:0; font-size:1.2rem;">Configuración</h2>
        <label>Grosor disco (cm)</label>
        <input type="number" id="kerf" value="0.3" step="0.1">
        
        <div id="piecesList">
            <div class="piece-entry">
                <input type="text" placeholder="Nombre pieza" style="width:50%">
                <div style="display:flex; gap:5px">
                    <input type="number" class="w" placeholder="Ancho" value="60">
                    <input type="number" class="l" placeholder="Largo" value="120">
                    <input type="number" class="q" placeholder="Cant" value="2">
                </div>
                <button class="btn-del" onclick="this.parentElement.remove()">Eliminar</button>
            </div>
        </div>

        <button class="btn btn-add" onclick="addRow()">+ Añadir Pieza</button>
        <button class="btn btn-calc" onclick="generate()">CALCULAR Y VER CORTES</button>
    </div>

    <div id="results"></div>

<script>
    function addRow() {
        const div = document.createElement("div");
        div.className = "piece-entry";
        div.innerHTML = `<input type="text" placeholder="Pieza" style="width:50%"><div style="display:flex; gap:5px"><input type="number" class="w" placeholder="Ancho"><input type="number" class="l" placeholder="Largo"><input type="number" class="q" placeholder="Cant"></div><button class="btn-del" onclick="this.parentElement.remove()">Eliminar</button>`;
        document.getElementById("piecesList").appendChild(div);
    }

    function generate() {
        const res = document.getElementById("results");
        res.innerHTML = "";
        const kerf = parseFloat(document.getElementById("kerf").value) || 0;
        const SW = 122, SL = 244;
        const SCALE = 4; // Escala aumentada para que se vea bien en celular

        let pieces = [];
        document.querySelectorAll(".piece-entry").forEach(el => {
            const w = parseFloat(el.querySelector(".w").value), l = parseFloat(el.querySelector(".l").value), q = parseInt(el.querySelector(".q").value);
            if(w && l && q) for(let i=0; i<q; i++) pieces.push({w: Math.min(w,l), l: Math.max(w,l), c: `hsl(${Math.random()*360}, 70%, 60%)`});
        });

        pieces.sort((a,b) => (b.w*b.l) - (a.w*a.l));

        while(pieces.length > 0) {
            let sheet = { p: [], area: 0 }, spaces = [{x:0, y:0, w:SW, l:SL}];
            for(let i=0; i<pieces.length; i++){
                let p = pieces[i], fit = false;
                for(let j=0; j<spaces.length; j++){
                    let s = spaces[j];
                    if(p.w <= s.w && p.l <= s.l) {
                        sheet.p.push({x:s.x, y:s.y, w:p.w, l:p.l, c:p.c});
                        sheet.area += (p.w*p.l);
                        if(s.w-p.w > 0) spaces.push({x:s.x+p.w+kerf, y:s.y, w:s.w-p.w-kerf, l:p.l});
                        if(s.l-p.l > 0) spaces.push({x:s.x, y:s.y+p.l+kerf, w:s.w, l:s.l-p.l-kerf});
                        spaces.splice(j,1); pieces.splice(i,1); i--; fit=true; break;
                    }
                }
            }

            const wrapper = document.createElement("div");
            wrapper.className = "sheet-wrapper";
            const canvas = document.createElement("canvas");
            canvas.width = SW * SCALE; canvas.height = SL * SCALE;
            const ctx = canvas.getContext("2d");
            
            ctx.fillStyle = "#fff7ed"; ctx.fillRect(0,0,canvas.width,canvas.height);
            sheet.p.forEach(p => {
                ctx.fillStyle = p.c; ctx.fillRect(p.x*SCALE, p.y*SCALE, p.w*SCALE, p.l*SCALE);
                ctx.strokeStyle = "#000"; ctx.strokeRect(p.x*SCALE, p.y*SCALE, p.w*SCALE, p.l*SCALE);
                
                if(p.w > 10) {
                    ctx.fillStyle = "white"; ctx.font = "bold 20px Arial";
                    ctx.shadowColor = "black"; ctx.shadowBlur = 4;
                    ctx.fillText(`${p.w}x${p.l}`, (p.x+2)*SCALE, (p.y+8)*SCALE);
                    ctx.shadowBlur = 0;
                }
            });

            wrapper.innerHTML = `<h3>Hoja ${res.children.length + 1}</h3><div class="stats">Aprovechamiento: ${((sheet.area/(SW*SL))*100).toFixed(1)}%</div>`;
            wrapper.appendChild(canvas);
            res.appendChild(wrapper);
        }
    }
</script>
</body>
</html>
